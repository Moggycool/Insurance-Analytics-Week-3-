name: Python CI/CD

on:
    push:
        branches: [main, task-1]
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                # Test with Python versions that work with your packages
                python-version: ["3.10", "3.11", "3.12"]
                exclude:
                    # Exclude if specific packages don't work
                    - python-version: "3.13"
                      # Some packages might not support 3.13 yet

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Generate platform-agnostic requirements
              run: |
                  # Create requirements without Windows packages
                  python -c "
                  import re

                  # Read original requirements
                  with open('requirements.txt', 'r') as f:
                      lines = f.readlines()

                  # Filter out Windows-only packages
                  windows_packages = ['pywin32', 'pywinpty']
                  filtered_lines = []

                  for line in lines:
                      line = line.strip()
                      if not line or line.startswith('#'):
                          filtered_lines.append(line)
                          continue
                          
                      # Check if line contains Windows-only package
                      is_windows = False
                      for pkg in windows_packages:
                          if re.match(f'^{pkg}==', line):
                              print(f'Skipping Windows-only package: {line}')
                              is_windows = True
                              break
                      
                      if not is_windows:
                          filtered_lines.append(line)

                  # Write filtered requirements
                  with open('requirements-ci.txt', 'w') as f:
                      f.write('\n'.join(filtered_lines))

                  print('Generated requirements-ci.txt')
                  "

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pytest

                  # Try installing, skipping any remaining incompatible packages
                  if [ -f requirements-ci.txt ]; then
                    # Install line by line, skipping failures
                    while IFS= read -r line || [ -n "$line" ]; do
                      if [[ -n "$line" && ! "$line" =~ ^# ]]; then
                        echo "Installing: $line"
                        pip install "$line" 2>/dev/null || echo "Failed to install: $line (skipping)"
                      fi
                    done < requirements-ci.txt
                  fi

            - name: Test with pytest
              run: |
                  # Run tests if they exist
                  if [ -d "tests" ]; then
                    python -m pytest tests/ -v
                  else
                    echo "No tests directory found"
                  fi

            - name: Run code formatting check
              run: |
                  pip install black
                  black --check src/ tests/
